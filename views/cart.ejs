<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/header1.ejs') %>
  <title>Your Cart</title>
</head>
<body>
  <header>
    <h1>The Baker Barns Bakery</h1>
    <%- include('partials/navbar1.ejs') %>
  </header>

  <main>
    <div class="cart-container">
      <h2>Your Shopping Cart</h2>

      <% if (cartItems && cartItems.length) { %>
        <table class="cart-table cart-table--outlined">
          <thead>
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Subtotal</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <% let total = 0; %>
            <% cartItems.forEach((item) => { 
                 // Support either item.name or item.product_name from DB
                 const name = item.name || item.product_name || 'Item';
                 const price = parseFloat(item.price) || 0;
                 const qty   = parseInt(item.quantity, 10) || 0;
                 const sub   = price * qty;
                 total += sub;
            %>
              <tr>
                <td><%= name %></td>

                <!-- Update quantity (uses item_id as your routes expect) -->
                <td>
                  <form method="POST" action="/cart/update" class="inline-form">
                    <input type="hidden" name="item_id" value="<%= item.item_id %>">
                    <input type="number" name="quantity" value="<%= item.quantity %>" min="1" style="width:70px;">
                    <button type="submit" class="btn btn-primary btn-sm">Update</button>
                  </form>
                </td>

                <!-- <td>$<%= price.toFixed(2) %></td>
                <td>$<%= sub.toFixed(2) %></td> -->
                <td>$<%= Number(item.price || 0).toFixed(2) %></td>
                <td>$<%= (Number(item.price || 0) * Number(item.quantity || 0)).toFixed(2) %></td>

                <!-- Remove line -->
                <td>
                  <form method="POST" action="/cart/remove" class="inline-form">
                    <input type="hidden" name="item_id" value="<%= item.item_id %>">
                    <button type="submit" class="btn btn-accent btn-sm">Remove</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-right"><strong>Total</strong></td>
              <td colspan="2">
                <!-- <strong>$<%= total.toFixed(2) %></strong> -->
                <strong>Total: $<%= cartItems.reduce((s,i)=> s + (i.price||0)*(i.quantity||0), 0).toFixed(2) %></strong>
              </td>
            </tr>
          </tfoot>
        </table>

        <div style="text-align:right;">
          <a href="/checkout" class="btn btn-primary">Proceed to Checkout</a>
        </div>
      <% } else { %>
        <p>Your cart is empty.</p>
        <a href="/products" class="btn btn-primary">Browse Products</a>
      <% } %>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 The Baker Barns Bakery</p>
  </footer>
</body>
</html>
