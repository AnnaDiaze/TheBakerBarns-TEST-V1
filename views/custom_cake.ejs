<!-- views/custom_cake.ejs -->
<!doctype html>
<html>
<head>
  <title>Customize Cake</title>
  <%- include('partials/header1.ejs') %>
</head>
<body>
  
  <header>
    <h1>The Baker Barns Bakery</h1>
    <%- include('partials/navbar1.ejs') %>
  </header>

  <main>
    <h3>Customize Your Cake</h3>

    <form id="customCakeForm" class="custom-form">
      <div>
        <label for="productSelect">Choose base cake</label><br>

        <!-- Replace the select + loops with defensive versions -->
        <select id="productSelect" name="product_id" required>
          <% (cakes || []).forEach(c => { %>
            <option value="<%= c.id %>" data-base="<%= Number(c.price).toFixed(2) %>">
              <%= c.name %> ‚Äî $<%= Number(c.price).toFixed(2) %>
            </option>
          <% }) %>
        </select>
        
        <% Object.keys(optionsByType || {}).forEach(type => { %>
          <div class="option-group">
            <label><%= type %></label>
            <select name="option_ids" class="option-select" multiple>
              <% (optionsByType[type] || []).forEach(o => { %>
                <option value="<%= o.id %>" data-price="<%= Number(o.price_extra).toFixed(2) %>">
                  <%= o.name %> (+$<%= Number(o.price_extra).toFixed(2) %>)
                </option>
              <% }) %>
            </select>
          </div>
        <% }) %>
      </div>
      

      <div>
        <label>Quantity</label>
        <input type="number" name="quantity" value="1" min="1" />
      </div>

      <div id="summary" class="summary-box">
        Base: $<span id="summaryBase">0.00</span><br>
        Add-ons: $<span id="summaryAddons">0.00</span><br>
        <strong>Total: $<span id="summaryTotal">0.00</span></strong>
      </div>

      <div>
        <label>Notes (optional)</label><br>
        <textarea name="notes" rows="2" cols="40" placeholder="Message on cake, special instructions..."></textarea>
      </div>

      <div>
        <button type="submit" id="submitCustomCake" class="btn btn-primary">Add to Cart</button>
      </div>
    </form>
  </main>

 <!-- Add JS for AJAX -->
  <!-- Add JS for AJAX -->
<script>
function computeTotals() {
  const baseSel = document.getElementById("productSelect");
  const base = parseFloat(baseSel.selectedOptions[0]?.dataset.base || "0") || 0;

  const addon = Array.from(document.querySelectorAll(".option-select"))
    .flatMap(sel => Array.from(sel.selectedOptions))
    .reduce((sum, opt) => sum + (parseFloat(opt.dataset.price || "0") || 0), 0);

  const qty = parseInt(document.querySelector('input[name="quantity"]').value || "1", 10);

  document.getElementById("summaryBase").textContent = base.toFixed(2);
  document.getElementById("summaryAddons").textContent = addon.toFixed(2);
  document.getElementById("summaryTotal").textContent = (base + addon).toFixed(2);
}

document.getElementById("productSelect").addEventListener("change", computeTotals);
document.querySelectorAll(".option-select").forEach(sel => sel.addEventListener("change", computeTotals));
computeTotals();

document.getElementById("customCakeForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const optionIds = Array.from(document.querySelectorAll(".option-select"))
    .flatMap(sel => Array.from(sel.selectedOptions).map(o => o.value));

  const payload = {
    product_id: document.getElementById("productSelect").value,
    quantity: document.querySelector('input[name="quantity"]').value,
    notes: document.querySelector('textarea[name="notes"]').value,
    option_ids: optionIds
  };

  try {
    const res = await fetch("/custom_cake/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.success) {
      alert("üéÇ Custom cake added to cart!");

      // ‚úÖ Update cart count in navbar (same logic as products.ejs)
      const cartLink = document.querySelector('a[href="/cart"]');
      if (cartLink) {
        const countMatch = cartLink.textContent.match(/\((\d+)\)/);
        let count = countMatch ? parseInt(countMatch[1]) : 0;
        count += parseInt(payload.quantity);
        cartLink.textContent = `üõí Cart (${count})`;
      }

    } else {
      alert(`‚ö†Ô∏è ${data.error || "Could not add custom cake."}`);
    }
  } catch (err) {
    console.error("Custom cake create failed:", err);
    alert("üö´ Network/server error.");
  }
});
</script>


<footer>
    <p>&copy; 2025 The Baker Barns Bakery</p>
  </footer>
 </body>
</html>