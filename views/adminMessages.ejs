<!DOCTYPE html>
<html>
<head>
  <%- include('partials/header1.ejs') %>
  <title>Admin – Manage Messages</title>
</head>
<body>
  <header>
    <h1>The Baker Barns Bakery</h1>
    <%- include('partials/navbar1.ejs') %>
  </header>

  <!-- Admin nav (same classes as adminOrders.ejs) -->
  <nav class="cart-container cart-container--wide admin-actionbar">
    <a class="btn btn-accent" href="/adminOnly">Admin Panel</a>
    <a class="btn btn-primary" href="/admin/Orders">Manage Orders</a>
    <a class="btn btn-primary" href="/admin/Products">Manage Products</a>
    <a class="btn btn-primary" href="/admin/Recipes">Manage Recipes</a>
    <a class="btn btn-primary" href="/admin/Messages">Manage Messages</a>
    <a class="btn btn-primary" href="/admin/Users">Manage Users</a>
  </nav>

  <main class="cart-container cart-container--wide">
    <h2 style="text-align:left; margin:0 0 16px;">Manage Messages</h2>

    <!-- Filters -->
    <form method="GET" action="/admin/Messages" class="d-flex flex-wrap" style="gap:8px; margin-bottom:16px;">
      <select name="status" class="form-control" style="max-width:200px;">
        <option value="">All statuses</option>
        <option value="new"     <%= (currentStatus === 'new' ? 'selected' : '') %>>new</option>
        <option value="read"    <%= (currentStatus === 'read' ? 'selected' : '') %>>read</option>
        <option value="replied" <%= (currentStatus === 'replied' ? 'selected' : '') %>>replied</option>
      </select>

      <input type="text" name="q" value="<%= queryText %>" class="form-control" placeholder="Search name, email, message..." style="max-width:320px;">
      <button class="btn btn-primary" type="submit">Filter</button>
      <a class="btn btn-accent" href="/admin/Messages">Reset</a>
    </form>

    <div class="table-responsive">
      <table class="cart-table cart-table--outlined">
        <thead>
          <tr>
            <th>ID</th>
            <th style="width:150px;">From</th>
            <th>Email</th>
            <th style="width:350px;">Message</th>
            <th>Status</th>
            <th style="width:250px;">Updated</th>
          </tr>
        </thead>
        <tbody>
          <% (messages || []).forEach(m => { 
               const updated = m.updated_at ? new Date(m.updated_at) : null;
               const updatedStr = updated && !isNaN(updated) ? updated.toLocaleString() : '';
          %>
            <tr data-row="<%= m.message_id %>">
              <td>#<%= m.message_id %></td>
              <td><%= [m.first_name, m.last_name].filter(Boolean).join(' ') || '—' %></td>
              <td><a href="mailto:<%= m.email %>"><%= m.email %></a></td>
              <td style="white-space:pre-wrap;"><%= m.message %></td>
              <td>
                <div style="display:flex; align-items:center;">
                  <select class="form-control" data-id="<%= m.message_id %>" style="min-width:140px;">
                    <option value="new"     <%= m.status === 'new' ? 'selected' : '' %>>new</option>
                    <option value="read"    <%= m.status === 'read' ? 'selected' : '' %>>read</option>
                    <option value="replied" <%= m.status === 'replied' ? 'selected' : '' %>>replied</option>
                  </select>
                  <span class="badge" data-pill="<%= m.message_id %>"><%= m.status %></span>
                </div>
                <div class="text-muted" data-feedback="<%= m.message_id %>" style="font-size:12px;"></div>
              </td>
              <td><%= updatedStr %></td>
            </tr>
          <% }) %>

          <% if (!messages || messages.length === 0) { %>
            <tr><td colspan="6" class="text-muted">No messages found.</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <div style="margin-top:8px;">
      <a href="/adminOnly" class="btn btn-primary">← Back</a>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 The Baker Barns Bakery</p>
  </footer>

  <script>
    // Inline status update (uses callback-route /update/:id to match your adminOrders style)
    document.querySelectorAll('select[data-id]').forEach(sel => {
      sel.addEventListener('change', async (e) => {
        const id = e.target.getAttribute('data-id');
        const status = e.target.value;

        const feedback = document.querySelector('[data-feedback="'+id+'"]');
        const pill = document.querySelector('[data-pill="'+id+'"]');
        if (feedback) feedback.textContent = 'Saving...';

        try {
          const resp = await fetch('/admin/Messages/update/' + id, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
          });

          const data = await resp.json();
          if (data.ok) {
            if (feedback) feedback.textContent = 'Saved';
            if (pill) pill.textContent = status;
          } else {
            if (feedback) feedback.textContent = data.error || 'Save failed';
          }
        } catch (err) {
          console.error(err);
          if (feedback) feedback.textContent = 'Network error';
        }

        setTimeout(() => { if (feedback) feedback.textContent = ''; }, 2000);
      });
    });
  </script>
</body>
</html>
