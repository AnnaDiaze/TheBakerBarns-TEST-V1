<html>
<head>
    <%- include('partials/header1.ejs') %>
</head>
<body>
  <header>
    <h1>The Baker Barns Bakery</h1>
    <%- include('partials/navbar1.ejs') %>
  </header>

  <!-- products side-bar -->
  <aside class="sidebar">
    <h3>Shop Online</h3>
    <ul>
      <% categories.forEach(cat => { %>
        <li>
          <a 
            href="/products?category=<%= cat.id %>" 
            class="<%= currentCategory == cat.id ? 'active' : '' %>">
            <%= cat.name %>
          </a>
        </li>
      <% }) %>
    </ul>
  </aside>

  <!-- Main Section -->
  <main class="products-main">
    <!-- Sorting -->
    <div class="sort-bar">
      <span>Showing <%= products.length %> results</span>
      <div class="sort-select">
        <label for="sort">Sort by:</label>
        <select id="sort" name="sort" onchange="location = '?sort=' + this.value;">
          <option value="default" <%= sort === 'default' ? 'selected' : '' %>>Default</option>
          <option value="name" <%= sort === 'name' ? 'selected' : '' %>>Name (Aâ€“Z)</option>
          <option value="price_low" <%= sort === 'price_low' ? 'selected' : '' %>>Price (Low â†’ High)</option>
          <option value="price_high" <%= sort === 'price_high' ? 'selected' : '' %>>Price (High â†’ Low)</option>
        </select>
      </div>
    </div>

    <!-- Product Grid -->
    <div class="product-grid">
      <% products.forEach(product => { %>
        <div class="product-card">
          <img src="<%= product.image_url %>" alt="<%= product.name %>">
          <h3><%= product.name %></h3>
          <p class="price">$<%= (parseFloat(product.price) || 0).toFixed(2) %></p>
          
          <form class="cart-form" data-product-id="<%= product.id %>">
            <input type="number" name="quantity" value="1" min="1">
            <button type="submit" class="btn">Add to Cart</button>
          </form>          

        </div>
      <% }) %>
    </div>
</div>
  </main>

  <!-- Add JS for AJAX -->
<script>
document.querySelectorAll('.cart-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const productId = form.getAttribute('data-product-id');
    const quantity = form.querySelector('input[name="quantity"]').value;

    const res = await fetch('/cart/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ product_id: productId, quantity })
    });

    const data = await res.json();

    if (data.success) {
      // Update cart count in navbar
      const cartLink = document.querySelector('a[href="/cart"]');
      const countMatch = cartLink.textContent.match(/\((\d+)\)/);
      let count = countMatch ? parseInt(countMatch[1]) : 0;
      count += parseInt(quantity);
      cartLink.textContent = `ðŸ›’ Cart (${count})`;

      alert("Item added to cart!");
    } else {
      alert("Failed to add item");
    }
  });
});
</script>


</body>
</html>
